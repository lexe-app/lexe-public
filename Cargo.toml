[workspace]
resolver = "2"

members = [
    "app-rs",
    "common",
    "lexe-ln",
    "node",
    "run-sgx",
]

[patch.crates-io]
# NOTE: Make sure to duplicate any changes to the `server`'s root Cargo.toml,
# otherwise the `server`'s dependency versions won't match.
aesm-client = { git = "https://github.com/lexe-tech/rust-sgx", branch = "lexe" }
async-usercalls = { git = "https://github.com/lexe-tech/rust-sgx", branch = "lexe" }
atty = { git = "https://github.com/softprops/atty", rev = "6633c0e1446aa19e6cd00e00e39770da43081bda" }
dcap-ql = { git = "https://github.com/lexe-tech/rust-sgx", branch = "lexe" }
enclave-runner = { git = "https://github.com/lexe-tech/rust-sgx", branch = "lexe" }
hyper = { git = "https://github.com/lexe-tech/hyper", branch = "hyper-sgx-0.14.18" }
mio = { git = "https://github.com/lexe-tech/mio", branch = "mio-sgx-0.8.4" }
reqwest = { git = "https://github.com/lexe-tech/reqwest", branch = "lexe" }
ring = { git = "https://github.com/lexe-tech/ring", branch = "support-sgx-0.16.20" }
sgx-isa = { git = "https://github.com/lexe-tech/rust-sgx", branch = "lexe" }
sgxs-loaders = { git = "https://github.com/lexe-tech/rust-sgx", branch = "lexe" }
tokio = { git = "https://github.com/lexe-tech/tokio",  branch = "tokio-sgx-1.21.2" }

# This BDK fork:
# 1) Derives PartialEq, Eq for SyncTime, used in tests
# 2) Makes bdk::Wallet and EsploraBlockchain thread-safe* (finally Send!) under
#    the condition that bdk::Wallet is wrapped in a Mutex of some sort.
#    *See the commit messages in the patch for details.
# 3) Reintroduces the Send bound in bdk-macros' `async_trait`s, required for (2)
bdk = { git = "https://github.com/lexe-tech/bdk", branch = "lexe-v0.26-synctime-threadsafe" }
bdk-macros = { git = "https://github.com/lexe-tech/bdk", branch = "lexe-v0.26-synctime-threadsafe" }
# bdk = { path = "../../bdk", default-features = false, features = ["async-interface", "use-esplora-async"] }

# Like 0.0.112, 0.0.113 is broken; LDK panics with 50% probability if we use
# random nanos: https://github.com/lightningdevkit/rust-lightning/pull/1935
# We also need lightning-transaction-sync which has not been merged yet.
# TODO(max): Switch back to crates.io version once:
# 1) A version of LDK is released which passes our integration tests (0.0.114?)
# 2) LDK#1870 containing the lightning-transaction-sync crate is merged.

# For if we need to run a patched version of LDK instead of crates.io.
lightning = { git = "https://github.com/lexe-tech/rust-lightning", branch = "lexe-v0.0.113-with-fix-with-tx-sync-v2" }
lightning-invoice = { git = "https://github.com/lexe-tech/rust-lightning", branch = "lexe-v0.0.113-with-fix-with-tx-sync-v2" }
lightning-net-tokio = { git = "https://github.com/lexe-tech/rust-lightning", branch = "lexe-v0.0.113-with-fix-with-tx-sync-v2" }
lightning-transaction-sync = { git = "https://github.com/lexe-tech/rust-lightning", branch = "lexe-v0.0.113-with-fix-with-tx-sync-v2" }

# For debugging LDK or testing patches during local development
# lightning = { path = "../../ldk/lightning", features = ["max_level_trace"]}
# lightning-invoice = { path = "../../ldk/lightning-invoice" }
# lightning-net-tokio = { path = "../../ldk/lightning-net-tokio" }
# lightning-transaction-sync = { path = "../../ldk/lightning-transaction-sync" }

[profile.dev]
# This fixes 'warning: can't find symbol' when debugging, but breaks the
# server's build.rs, so it should always be commented out in git. More info:
# https://github.com/rust-lang/rust/issues/40787#issuecomment-1019465942
# https://doc.rust-lang.org/cargo/reference/profiles.html#split-debuginfo
# split-debuginfo = "packed"

[profile.release]
panic = "abort"
# NOTE(phlip9): enable for smaller binary size
# codegen-units = 1
# lto = true
# opt-level = "s"
# debug = 0
# strip = "debuginfo"

# [profile.dev]
# panic = "abort"
