[workspace]
resolver = "2"

members = [
    "app-rs",
    "app-rs-codegen",
    "common",
    "gdrive",
    "lexe-ln",
    "logger",
    "node",
    "run-sgx",
    "sgx-test",
    "sgx-toml",
    "sgxs-sign",
]

[workspace.package]
authors = [
    "Max Fang <max@lexe.app>",
    "Philip Hayes <philip@lexe.app>"
]
edition = "2021"
license = "PolyForm Noncommercial License 1.0.0"
# This is just a default version which can be inherited by workspace members
# that don't actually need semver versioning. Crates that require versioning
# will specify their version in their Cargo.toml as usual.
version = "0.1.0"

[workspace.dependencies]
# Use this section to declare dependencies used across multiple lexe crates.
# Lexe crates can then inherit the dependency using `workspace = true`.
# This makes it easier to keep dependency versions in sync. More info:
# https://doc.rust-lang.org/cargo/reference/workspaces.html#the-dependencies-table

# Ad hoc error definition, easy error propagation, error chains
anyhow = "1"
# Like `RwLock<Arc<T>>` for read-mostly, write-seldom scenarios.
arc-swap = "1.6"
# Derive-based command line argument parsing
argh = "0.1"
# async fn's in trait methods
async-trait = "0.1"
# Converting to/from base 64.
base64 = "0.13"
# rust-bitcoin suite of libraries
bitcoin = "0.29"
bitcoin-bech32 = "0.12"
bitcoin_hashes = "0.11"
# Abstractions for working with bytes
bytes = "1"
# Write #[cfg(..)] if-else statements without repeating clauses
cfg-if = "1"
# Datetime utilities
chrono = { version = "0.4", default-features = false, features = [
    "std",
    "clock"
] }
# Allows setting environment variables using a .env file.
# dotenvy is a better maintained fork of dotenv
dotenvy = "0.15"
# High-level memory-safe Rust<->Dart FFI bindings.
flutter_rust_bridge = { version = "=1.82.6", default-features = false, features = [] }
# The Rust+Dart codegen for flutter_rust_bridge
flutter_rust_bridge_codegen = { version = "=1.82.6", default-features = false, features = [] }
# Utils for working with futures
futures = "0.3"
# Low-level async HTTP library and server
# Use both hyper 0.14.28 and 1.0 at the same time while we transition
hyper = { version = "1", default-features = false }
hyper_old = { version = "=0.14.28", package = "hyper", default-features = false, features = ["deprecated"] }
# Property-based testing
proptest = { version = "1", default-features = false }
# Arbitrary derive macro
proptest-derive = "0.4"
# Traits and utilities for generating randomness
rand = { version = "0.8", default-features = false }
rand_core = { version = "0.6", default-features = false, features = ["alloc"] }
# Easily generate x509 certs with ring
rcgen = { version = "0.10", default-features = false, features = ["zeroize"] }
# Decimal number representation suitable for financial calculations
rust_decimal = { version = "1", default-features = false, features = ["serde"] }
rust_decimal_macros = { version = "1", default-features = false }
# TLS library
rustls = { version = "0.21", default-features = false }
# A wrapper type for carefully handling secrets
secrecy = "0.8"
# SemVer version newtype for parsing and precedence
semver = "1"
# Serialization / deserialization framework
serde = { version = "1", features = ["derive"] }
serde_with = { version = "3", default-features = false }
serde_json = "1"
# Temporary files and directories
tempfile = "3"
# Easy error definition
thiserror = "1"
# Datetime library used by rcgen. Should match rcgen's `time` version
time = "0.3"
# serde-compatible TOML-parsing library
toml = "0.7"
# Scoped, structured logging for asynchronous systems
tracing = "0.1"
tracing-core = "0.1"
tracing-subscriber = { version = "0.3", default-features = false }

# --- PATCHED DEPENDENCIES --- #
# Use this section to declare patched dependencies.
# - See the following [patch.crates-io] section for patch declarations.
# - The version should use `=` to pin the exact version our patch applies to.
#   `=` ensures `cargo update` doesn't accidentally update the dependency,
#   leading to it becoming incompatible with our patch.

# A client for the Intel AESM service. Used during attestation to get quoted.
aesm-client = { version = "=0.5.4", default-features = false, features = ["sgxs"] }
# SGX Quote types
dcap-ql = { version = "=0.3.4", default-features = false }
# Fortanix EDP crate for running SGX applications, includes usercall extensions
enclave-runner = { version = "=0.5.1", default-features = false }
# Hyper-related utilities
hyper-util = { version = "=0.1.3", default-features = false }
# LDK (rust-lightning) libraries
lightning = { version = "=0.0.116", features = ["max_level_trace"] }
lightning-invoice = { version = "=0.24" }
lightning-net-tokio = { version = "=0.0.116" }
lightning-transaction-sync = { version = "=0.0.116", features = ["esplora-async"] }
# Required by tokio
mio = "=0.8.4"
# High-level HTTP client
reqwest = { version = "=0.11.26", default-features = false }
# Safe and small crypto primitives based on BoringSSL
ring = "=0.16.20"
# Core SGX types and platform intrinsics (for sealing, reports, etc...)
sgx-isa = "=0.4.0"
sgxs = "=0.7.3"
sgxs-loaders = "=0.3.3"
# Asynchronous runtime
tokio = { version = "=1.21.2", default-features = false }
# Filter-based webserver
warp = { version = "=0.3.6", default-features = false }

[patch.crates-io]
# NOTE: Make sure to duplicate any changes to the root Cargo.toml.

# Fortanix EDP (rust-sgx) crates:
# * Add async-usercalls
# * Allow users to redirect enclave standard input/output
# * update tokio from 0.2 to 1.15.0
# * usecall-extension examples need more unique name to silence warns
# * enclave-runner: just depend on tokio "1" vs. pinning exact version
# * Support building just ftxsgx-elf2sgxs on non-x86 platforms
aesm-client = { git = "https://github.com/lexe-app/rust-sgx", branch = "lexe-2023_09_27" }
async-usercalls = { git = "https://github.com/lexe-app/rust-sgx", branch = "lexe-2023_09_27" }
dcap-ql = { git = "https://github.com/lexe-app/rust-sgx", branch = "lexe-2023_09_27" }
enclave-runner = { git = "https://github.com/lexe-app/rust-sgx", branch = "lexe-2023_09_27" }
sgx-isa = { git = "https://github.com/lexe-app/rust-sgx", branch = "lexe-2023_09_27" }
sgxs = { git = "https://github.com/lexe-app/rust-sgx", branch = "lexe-2023_09_27" }
sgxs-loaders = { git = "https://github.com/lexe-app/rust-sgx", branch = "lexe-2023_09_27" }

# * Replace RefCell with tokio::sync::RwLock 
# * Wallet and EsploraBlockchain are thread-safe*+
# * Reduce CACHE_ADDR_BATCH_SIZE from 100 -> 1
# * chore: Update esplora-client 0.3->0.4
bdk = { git = "https://github.com/lexe-app/bdk", branch = "lexe-v0.27.1-2023_07_07" }
bdk-macros = { git = "https://github.com/lexe-app/bdk", branch = "lexe-v0.27.1-2023_07_07" }
# bdk = { path = "../../bdk", default-features = false, features = ["async-interface", "use-esplora-async"] }
# bdk-macros = { path = "../../bdk/macros" }

# * fix: enable socket2 only for client-legacy
# TODO(max): Remove this patch once hyper-util 0.1.4 is released
hyper-util = { git = "https://github.com/hyperium/hyper-util", rev = "370e798e4664313776810bdbb891390aeb204d5a" }

# * support sgx: Remove socket2 dependency. Just use tokio APIs directly. 
# TODO(max): Remove this patch once everything updates to hyper 1.0
hyper_old = { package = "hyper", git = "https://github.com/lexe-app/hyper", branch = "lexe-v0.14.28-2024_03_08" }

# * sgx: update SGX port
mio = { git = "https://github.com/lexe-app/mio", branch = "mio-sgx-0.8.4" }

# * proxy: Expose `ProxyScheme`, `set_custom_http_auth`
# * lib: Fail compilation if using insecure TLS roots
reqwest = { git = "https://github.com/lexe-app/reqwest", branch = "lexe-v0.11.26-2024_03_12" }

# * rand: Use RDRAND for SystemRandom on Intel SGX targets
# * cpu: use static cpuid feature set in SGX enclaves
# * build: Always build from source
# * build: exclude SGX from stack-protector 
ring = { git = "https://github.com/lexe-app/ring", branch = "lexe-v0.16.20-2023_09_26" }

# * sgx: update tokio SGX port from 1.15.0 to 1.21.2
# * features: remove fs compile error, since warp requires it. 
# * rename: lexe-tech -> lexe-app
tokio = { git = "https://github.com/lexe-app/tokio", branch = "lexe-1.21.2-2023_09_20" }

# miniscript v0.9.1 nightly compiler backport fix
#
# * Without this fix, nightly fails to compile `miniscript` due to an infinite
#   recursion.
# * The fix is already landed in the latest `miniscript` v0.10.0+; this branch
#   just backports the fix from
#   <https://github.com/rust-bitcoin/rust-miniscript/pull/546>.
#
# REMOVE this when `bdk` goes 1.0 (which will presumably use the latest
# `bitcoin` crate version).
miniscript = { git = "https://github.com/lexe-app/rust-miniscript", branch = "lexe-v0.9.1-infinite-recursion-fix" }

# * lightning-net-tokio: Propagate tracing spans
lightning = { git = "https://github.com/lexe-app/rust-lightning", branch = "lexe-v0.0.116-2023_08_02" }
lightning-invoice = { git = "https://github.com/lexe-app/rust-lightning", branch = "lexe-v0.0.116-2023_08_02" }
lightning-net-tokio = { git = "https://github.com/lexe-app/rust-lightning", branch = "lexe-v0.0.116-2023_08_02" }
lightning-transaction-sync = { git = "https://github.com/lexe-app/rust-lightning", branch = "lexe-v0.0.116-2023_08_02" }
# lightning = { path = "../../ldk/lightning" }
# lightning-invoice = { path = "../../ldk/lightning-invoice" }
# lightning-net-tokio = { path = "../../ldk/lightning-net-tokio" }
# lightning-transaction-sync = { path = "../../ldk/lightning-transaction-sync" }

# * Allow users to provide a preconfigured TLS configuration
# * add HTTP on-upgrade filter
# * trace: tweak warp request `tracing` to include request time directly
# * trace: extract `Response<Body>` directly to reduce friction
# * trace: Tweak tracing log messages
warp = { git = "https://github.com/lexe-app/warp", branch = "lexe-v0.3.6-2023_03_12" }

[profile.release]
# Enable "thin" LTO (link-time optimization) for better perf+binary size. "fat"
# LTO is marginally better perf-wise but much slower linking time.
lto = "thin"
strip = "debuginfo"

# The Rust profile used when building the node SGX enclave in release mode.
# These options are tuned through trial and error to minimize reproducibility
# issues :)
[profile.release-sgx]
inherits = "release"
panic = "unwind" # sometimes repro diff?
# panic = "abort"
codegen-units = 1
# lto = "fat" # big repro diff
lto = "thin"
# opt-level = 3 # big repro diff
opt-level = 2
debug = "none"
strip = "debuginfo"

# NOTE: dev includes `check`, `clippy`, `test`, etc
[profile.dev]
# Our debug binaries are seriously bloated with sections like `.debug_pubtypes`
# eating literally _hundreds_ of MiB. All this debug info is useless outside of
# a debugger, which we rarely use.
#
# > Generates the minimal amount of debug info for backtraces with filename/line
# > number info, but not anything else, i.e. no variable or function parameter
# > info.
debug = "line-tables-only"
# This fixes 'warning: can't find symbol' when debugging, but breaks the
# server's build.rs, so it should always be commented out in git. More info:
# https://github.com/rust-lang/rust/issues/40787#issuecomment-1019465942
# https://doc.rust-lang.org/cargo/reference/profiles.html#split-debuginfo
# split-debuginfo = "packed"

# optimize some hot crypto/low-level packages even in debug mode
[profile.dev.package.ring]
opt-level = 3
[profile.dev.package.spin]
opt-level = 3
[profile.dev.package.untrusted]
opt-level = 3
[profile.dev.package.secp256k1]
opt-level = 3
[profile.dev.package.secp256k1-sys]
opt-level = 3
[profile.dev.package.bitcoin_hashes]
opt-level = 3
[profile.dev.package.base64]
opt-level = 3
[profile.dev.package.bytes]
opt-level = 3
